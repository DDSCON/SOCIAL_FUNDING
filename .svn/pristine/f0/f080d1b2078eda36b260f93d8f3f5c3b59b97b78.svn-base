<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
	<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
	
   	<%
    if(session.getAttribute("email")==null)
    {
    response.sendRedirect("/action/paymentStep1?seq="+request.getParameter("seq"));
   }
    %>
    
	<jsp:include page="../main/header.jsp"></jsp:include>
	
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>결제</title>

<script type="text/javascript"
	src="https://api.paygate.net/ajax/common/OpenPayAPI.js"></script>

<style type="text/css">
.main {
	padding: 50px 50px 50px 50px;
	margin: 0 auto;
}

.op1 {
	padding: 10px 10px 10px 10px;
	border-radius: 5px;
	margin-bottom: 10px;
	margin-top: 10px;
	vertical-align: middle;
}

#creditcard {
	padding: 10px 10px 10px 10px;
	margin: 10px 10px 10px 10px;
	text-align: left;
	border-radius: 5px;
}

#opa_form_title, #opa_form_command{
	
	font-size: 14px;
	background-color: #f9f9f7;
	display: none;
	
}

#opa_form_content{
	
	font-size: 14px;
	background-color: #f9f9f7;

}


#opa_form_content2{
	
	background-color: #ffffff;
	border: 1px solid black;

}

.pay{
	
	width:800px;
	display:block;
}

.choose{
	padding: 10px 10px 10px 10px;
	margin: 10px 10px 10px 10px;
	border-radius: 5px;
	border: 1px solid black;
	margin-bottom: 10px;
	vertical-align: middle;
	line-height: 50px;

}

table, th, td {
   	padding: 10px 10px 10px 10px;
	margin: 10px 10px 10px 10px;
}


.project_image {

	width: 300px;
	height: auto;
	border: 1px solid black;
	
}

</style>

<script type="text/javascript">
function startPayment() {
 doTransaction(document.PGIOForm);
}
</script> 




<script type="text/javascript">

function getPGIOresult() {
		var replycode = document.PGIOForm.elements['replycode'].value;
		var replyMsg = document.PGIOForm.elements['replyMsg'].value;
		displayStatus(getPGIOElement('ResultScreen'));

		verifyReceived(getPGIOElement('tid'), 'callbacksuccess', 'callbackfail');
	}
	function callbacksuccess() {
		if (replycode == '0000') {
			// 거래성공 경우 for transaction
			
			document.PGIOForm.action = '/action/paymentStep3';
			document.PGIOForm.submit();
		} else {
			// 거래실패 경우 for transaction

			document.PGIOForm.action = '/action/paymentStep3';
			document.PGIOForm.submit();
		}
	}
	function callbackfail() {
	
		// paygate system error
	}
	
	
	
</script>

<script>
$(document).ready(function() {
    $('#creditcardpay').click(function() {
            $('#creditcard').slideToggle("fast");
            $('#paychoose').fadeToggle("fast");
    });
    
    $('#cancel').click(function() {
        $('#paychoose').slideToggle("fast");
        $('#creditcard').fadeToggle("fast");
	});
});
</script>

<script>
function check() {
	 var cardtype = document.getElementById ("cardtype");
	 var cardnumber = $.trim($("#cardnumber").val());
	 var cardexpiremonth = $.trim($("#cardexpiremonth").val());
	 var cardexpireyear = $.trim($("#cardexpireyear").val());
	 
	 if(!cardtype.options[0].selected && cardnumber.length>0 && cardexpiremonth.length>0 && cardexpireyear.length>0) {
	
		 $('#checkform').fadeToggle("fast");
		 startPayment();
		
		
	   } else {

	     $("#checkform").html("<font color=red>&nbsp; &nbsp;결제 정보를 빠짐없이 입력하세요</font>");
	  }
	}
</script>


<!-- <script language="javascript"> 
function S_text_copy(z) 
{ 
	 if(z.options[z.selectedIndex].value) {  
    tmp1 = z.options[z.selectedIndex].text; 
    tmp2= z.options[z.selectedIndex].value;
    
    document.getElementById('card_company').value= tmp1;
    document.getElementById('card_company_code').value= tmp2;
    } 
} 
</script> -->

<script>

 function S_text_copy(z) 
{ 
	 if(z.options[z.selectedIndex].value) {  
    tmp1 = z.options[z.selectedIndex].text; 
    tmp2= z.options[z.selectedIndex].value;
    
    document.getElementById('card_company').value= tmp1;
    document.getElementById('card_company_code').value= tmp2;
    } 
} 

</script>

</head>
<body> 

	<jsp:include page="../main/top.jsp"></jsp:include>

	<div class="main" align="center" style="width: 800px">

		<div>
			옵션 선택 > <font color="red">결제</font> > 결제 완료
		</div>

				<c:forEach var="selectedproject" items="${mains}">
				<div class="op1" style="width: 400px; background: #f9f9f7">
				[${selectedproject.title}] 프로젝트<br><img src="/resources/upload/${selectedproject.image}" class="project_image"/><br> ${selectedproject.blurb}<br>
				선택한 옵션: <%=request.getParameter("o_description")%></div>
				<div class="op0" style="width: 400px; height: auto;">
					이 프로젝트에 <font color=red><%=request.getParameter("money")%></font>원을
					후원하시게 됩니다. <br> 결제 방식을 선택하세요.
				</div>
				</c:forEach>
				
				

				
<c:forEach var="selectedproject" items="${mains}">				
<div id="paychoose">
<table>
  <tr>
    <td><img src="http://creditcard.calculatorsaustralia.com.au/sites/default/files/credit-card-calculator-image.png" height="100" width="130" id="creditcardpay"></td>
    
    <td><form method="get" action="https://www.sandbox.paypal.com/cgi-bin/webscr" style="width: 160px;">
<input type=hidden name="cmd" value="_xclick" size="50" />
<input type=hidden name="business" value="ganjangsauce-facilitator@gmail.com" size="50" />
<input type=hidden name="amount" value="<%= Float.parseFloat(request.getParameter("money"))/1000 %>" size="50" />
<input type=hidden name="item_name" value="[${selectedproject.title}] 프로젝트 후원" size="50" />
<input type=hidden name="return" value="http://localhost/action/paypal?seq=<%=request.getParameter("seq") %>&m_seq=${sessionScope.seq}&email=${email}&p_seq=<%=request.getParameter("seq") %>&option_no=<%=request.getParameter("option_no") %>&pay_money=<%=request.getParameter("money") %>&o_description=<%=request.getParameter("o_description") %>" size="50" />
<c:forEach var="payment" items="${payinfo}">
<input type=hidden name="notify_url" value="http://localhost/action/paypal?seq=<%=request.getParameter("seq") %>&m_seq=${sessionScope.seq}&email=${email}&p_seq=<%=request.getParameter("seq") %>&option_no=<%=request.getParameter("option_no") %>&pay_money=<%=request.getParameter("money") %>&o_description=<%=request.getParameter("o_description") %>" size="50" />
</c:forEach>
<input type=hidden name="cancel_return" value="http://localhost/action/paymentStep1?seq=<%=request.getParameter("seq") %>" size="50" />
<input type=hidden name="charset" value="UTF-8" size="50" />
<input type=hidden name="currency_type" value="USD" size="50" />				
<input type="hidden" name="email" value="${email}" />
<input type="hidden" name="p_seq" value="<%=request.getParameter("seq") %>" />	
<img src="http://www.cyclingireland.ie/Uploads/Paypal.jpg" height="60" width="150" style="padding-top: 20px;" onclick="submit();">
</form></td>
  </tr>
</table>
</div>	

<div id="creditcard" style="background: #f9f9f7; display:none; width:400px;">
<br>
<form name="PGIOForm" align="left">

<input type=hidden size="10" name="mid" value="domestic"/>
<input type=hidden name="langcode" value="KR">
<input type=hidden size=8 name="charset" value="UTF-8"/>
<input type=hidden name=paymethod value="100">
<input type=hidden size=10 name="unitprice" value="<%=request.getParameter("money")%>"/>
<input type=hidden size=10 name=goodcurrency value="WON" >
<input type=hidden size="26" name="goodname" value="[${selectedproject.title}] 프로젝트 후원"/>
<input type=hidden size="26" name="receipttoname" value="Funday"/>
<input type=hidden size="26" name="receipttoemail" value="dev@paygate.net"/>
<input type=hidden size="26" name="tid" value=""/>
<input type=hidden size="26"  name="replycode" value=""/>
<input type=hidden size="26" name="replyMsg" value=""/>

</c:forEach>



&nbsp; &nbsp;<label>카드사 </label><select name="cardtype" id="cardtype" onkeypress="return enter2next(event, 'detectPayMethod_getBASICCardType2()')"  onchange="S_text_copy(this)" autofocus>

<option value="310">비씨(BC)카드</option>
<option value="310">MG새마을체크카드</option>
<option value="310">우체국(BC)카드</option>
<option value="310">KDB산업은행카드</option>
<option value="310">상호저축은행</option>
<option value="310">현대증권</option>
<option value="410">신한(LG)카드</option>
<option value="510">삼성카드</option>
<option value="610">현대카드</option>
<option value="110">국민(KB)카드</option>
<option value="710">롯데카드</option>
<option value="210">하나카드(구,외환)</option>
<option value="912">농협(NH)카드</option>
<option value="923">씨티카드</option>
<option value="916">하나카드(구,하나SK)</option>
<option value="913">우리카드</option>
<option value="918">광주카드</option>
<option value="920">전북카드</option>
<option value="925">수협카드</option>
<option value="610">신협(현대)카드</option>
<option value="921">제주카드</option>
<option value="511">삼성올앳카드</option>
<option id="cardcompanycode" value="<c:forEach var="payment" items="${payinfo}">${payment.card_company_code}</c:forEach>" selected="selected"><c:forEach var="payment" items="${payinfo}">${payment.card_company}</c:forEach></option>
</select><br><br>



&nbsp; &nbsp;<label>카드번호 </label><input name="cardnumber" id="cardnumber" value="<c:forEach var="payment" items="${payinfo}">${payment.card_num}</c:forEach>" size="16"/><br>



 

<br>
&nbsp; &nbsp;<label>만기(월[ex_07]) </label><input name="cardexpiremonth" id="cardexpiremonth" value="<c:forEach var="payment" items="${payinfo}">${payment.card_expire_month}</c:forEach>" size="2" /><br><br>
&nbsp; &nbsp;<label>만기(년[ex_2015]) </label><input name="cardexpireyear" id="cardexpireyear" value="<c:forEach var="payment" items="${payinfo}">${payment.card_expire_year}</c:forEach>" size="4" /><br><br>
			
			<input type="hidden" name="seq" value="<%=request.getParameter("seq") %>" />
			
			<c:forEach var="payment" items="${payinfo}">
			<input type=hidden name="m_seq" value="${sessionScope.seq}"/>
			<input type="hidden" name="email" value="${email}" />
			<input type="hidden" name="p_seq" value="<%=request.getParameter("seq") %>" />
			<input type="hidden" name="option_no" value="<%=request.getParameter("option_no") %>" />
			<input type="hidden" name="o_description" value="<%=request.getParameter("o_description") %>" />
			<input type="hidden" name="pay_money" value="<%=request.getParameter("money")%>" />
			<input type="hidden" id="card_company" name="card_company" value="${payment.card_company}" />
			<input type="hidden" id="card_company_code" name="card_company_code" value="${payment.card_company_code}" />
<%-- 			<input type="hidden" name="card_num" value="${payment.card_num}" />
			<input type="hidden" name="card_expire_month" value="${payment.card_expire_month}" />
			<input type="hidden" name="card_expire_year" value="${payment.card_expire_year}" /> --%>
			</c:forEach>
 </form>
<div id="checkform"> </div>
<div id="PGIOscreen" style="width: 385px; float: right"></div>
<table width="400px"><tr><td>
<input type="button" id="cancel" value="취소" /></td><td width="200px"></td><td>
<input type="button" id="payclick" value="결제" onclick='check()' /></td></tr>

</table>

</div>


	
</div>




	<jsp:include page="../main/footer.jsp"></jsp:include>

</body>
</html>